<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.home.broker.repository.AptInfoMapper">

    <!-- 요청1: sgg_cd, umd_cd, apt_seq 기반 조회 -->
    <select id="findEstateByCodes" resultType="com.ssafy.home.broker.dto.EstateResponse">
        SELECT
            h.apt_seq AS sptSeq,
            d.sido_name AS sggName,
            d.dong_name AS umdName,
            h.umd_nm,
            h.jibun,
            h.road_nm_sgg_cd,
            h.road_nm,
            h.road_nm_bonbun,
            h.road_nm_bubun,
            h.apt_nm,
            h.build_year,
            CAST(h.latitude AS DECIMAL(10, 6)) AS latitude,
            CAST(h.longitude AS DECIMAL(10, 6)) AS longitude,
            CONCAT(d.sido_name, ' ', d.gugun_name, ' ', d.dong_name, ' ', h.jibun) AS pullName
        FROM
            houseinfos h
                JOIN
            dongcodes d ON CONCAT(h.sgg_cd, h.umd_cd) = d.dong_code
        WHERE
            h.sgg_cd = #{sggCd}
          AND h.umd_cd = #{umdCd}
    </select>

    <select id="findEstatesByLocation" resultType="com.ssafy.home.broker.dto.EstateResponse">
        SELECT
            h.apt_seq AS sptSeq,
            d.sido_name AS sggName,
            d.dong_name AS umdName,
            h.umd_nm,
            h.jibun,
            h.road_nm_sgg_cd,
            h.road_nm,
            h.road_nm_bonbun,
            h.road_nm_bubun,
            h.apt_nm,
            h.build_year,
            h.latitude AS latitude,
            h.longitude AS longitude,
            CONCAT(d.sido_name, ' ', d.gugun_name, ' ', d.dong_name, ' ', h.jibun) AS pullName
        FROM
            houseinfos h
                JOIN
            dongcodes d ON CONCAT(h.sgg_cd, h.umd_cd) = d.dong_code
        WHERE
            h.latitude BETWEEN #{latMin} AND #{latMax}
          AND h.longitude BETWEEN #{lngMin} AND #{lngMax}
        ORDER BY
            sptSeq
    </select>

</mapper>
