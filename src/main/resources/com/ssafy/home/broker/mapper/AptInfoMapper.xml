<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.home.broker.repository.AptInfoMapper">

    <!-- 요청1: sgg_cd, umd_cd, apt_seq 기반 조회 -->
    <select id="findEstateByCodes" resultType="com.ssafy.home.broker.dto.EstateResponse">
        SELECT
            h.apt_seq AS sptSeq,
            d.sido_name AS sggName,
            d.dong_name AS umdName,
            h.umd_nm,
            h.jibun,
            h.road_nm_sgg_cd,
            h.road_nm,
            h.road_nm_bonbun,
            h.road_nm_bubun,
            h.apt_nm,
            h.build_year,
            CAST(h.latitude AS DECIMAL(10, 6)) AS latitude,
            CAST(h.longitude AS DECIMAL(10, 6)) AS longitude,
            CONCAT(d.sido_name, ' ', d.gugun_name, ' ', d.dong_name, ' ', h.jibun) AS pullName
        FROM
            houseinfos h
                JOIN
            dongcodes d ON CONCAT(h.sgg_cd, h.umd_cd) = d.dong_code
        WHERE
            h.sgg_cd = #{sggCd}
          AND h.umd_cd = #{umdCd}
    </select>

    <!-- 요청2: 위도, 경도를 기준으로 포함되는 아파트 리스트 조회 -->
    <select id="findEstatesByLocation" resultType="com.ssafy.home.broker.dto.EstateResponse">
        <!-- Haversine formula를 사용하여 반경 내의 위치 계산 -->
        SELECT
        h.apt_seq AS sptSeq,
        d.sido_name AS sggName,
        d.dong_name AS umdName,
        h.umd_nm,
        h.jibun,
        h.road_nm_sgg_cd,
        h.road_nm,
        h.road_nm_bonbun,
        h.road_nm_bubun,
        h.apt_nm,
        h.build_year,
        CAST(h.latitude AS DECIMAL(10, 6)) AS latitude,
        CAST(h.longitude AS DECIMAL(10, 6)) AS longitude,
        CONCAT(d.sido_name, ' ', d.gugun_name, ' ', d.dong_name, ' ', h.jibun) AS pullName
        FROM
        houseinfos h
        JOIN
        dongcodes d ON CONCAT(h.sgg_cd, h.umd_cd) = d.dong_code
        WHERE
        ( 6371 * acos(
        cos(radians(#{latitude}))
        * cos(radians(CAST(h.latitude AS DECIMAL(10, 6))))
        * cos(radians(CAST(h.longitude AS DECIMAL(10, 6))) - radians(#{longitude}))
        + sin(radians(#{latitude}))
        * sin(radians(CAST(h.latitude AS DECIMAL(10, 6))))
        )
        ) &lt;= #{radius}
        ORDER BY
        sptSeq
    </select>

</mapper>
